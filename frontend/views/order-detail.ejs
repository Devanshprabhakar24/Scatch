<%- include('./partials/header') %>

    <!-- Order Detail Section -->
    <div class="relative z-10 min-h-screen pt-28 pb-12 px-6">
        <div class="max-w-4xl mx-auto">
            <!-- Breadcrumb -->
            <nav class="mb-8 flex items-center gap-2 text-sm text-gray-500">
                <a href="/" class="hover:text-accent transition-colors">Home</a>
                <i class="ri-arrow-right-s-line"></i>
                <a href="/users/orders" class="hover:text-accent transition-colors">Orders</a>
                <i class="ri-arrow-right-s-line"></i>
                <span class="text-white"><%= order.orderId %></span>
            </nav>

            <!-- Order Header -->
            <div class="glass rounded-2xl p-6 mb-6 stagger-item">
                <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-space font-bold mb-2">
                            Order <span class="gradient-text"><%= order.orderId %></span>
                        </h1>
                        <p class="text-gray-400">
                            Placed on <%= new Date(order.createdAt).toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) %>
                        </p>
                    </div>
                    <div class="text-right">
                        <% 
                        let statusColor = 'yellow';
                        let statusIcon = 'ri-time-line';
                        if(order.orderStatus === 'confirmed') { statusColor = 'blue'; statusIcon = 'ri-checkbox-circle-fill'; }
                        if(order.orderStatus === 'processing') { statusColor = 'yellow'; statusIcon = 'ri-loader-4-line'; }
                        if(order.orderStatus === 'shipped') { statusColor = 'purple'; statusIcon = 'ri-truck-line'; }
                        if(order.orderStatus === 'delivered') { statusColor = 'green'; statusIcon = 'ri-checkbox-circle-fill'; }
                        if(order.orderStatus === 'cancelled') { statusColor = 'red'; statusIcon = 'ri-close-circle-fill'; }
                        %>
                        <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-<%= statusColor %>-500/20 text-<%= statusColor %>-400 text-sm font-medium capitalize">
                            <i class="<%= statusIcon %>"></i>
                            <%= order.orderStatus %>
                        </span>
                    </div>
                </div>

                <!-- Order Progress -->
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <% 
                        const steps = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'];
                        const currentStep = steps.indexOf(order.orderStatus);
                        const progress = order.orderStatus === 'cancelled' ? 0 : ((currentStep + 1) / steps.length) * 100;
                        %>
                        <div class="absolute top-4 left-0 right-0 h-1 bg-dark-card rounded-full">
                            <div class="h-full bg-gradient-to-r from-accent to-purple-500 rounded-full transition-all duration-500" style="width: <%= progress %>%"></div>
                        </div>
                    </div>
                    <div class="flex justify-between relative z-10 pt-2">
                        <% steps.forEach(function(step, index) { %>
                        <div class="text-center">
                            <div class="w-10 h-10 rounded-full <%= index <= currentStep && order.orderStatus !== 'cancelled' ? 'bg-gradient-to-r from-accent to-purple-500' : 'bg-dark-card' %> flex items-center justify-center mx-auto mb-2 border-2 border-transparent">
                                <% if(index <= currentStep && order.orderStatus !== 'cancelled') { %>
                                <i class="ri-check-line text-white"></i>
                                <% } else { %>
                                <span class="text-gray-500 text-sm"><%= index + 1 %></span>
                                <% } %>
                            </div>
                            <span class="text-xs <%= index <= currentStep && order.orderStatus !== 'cancelled' ? 'text-white' : 'text-gray-500' %> capitalize hidden sm:block"><%= step %></span>
                        </div>
                        <% }) %>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- Order Items -->
                <div class="md:col-span-2 space-y-6">
                    <div class="glass rounded-2xl p-6 stagger-item">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="ri-shopping-bag-line text-accent"></i>
                            Order Items (<%= order.products.length %>)
                        </h3>
                        <div class="space-y-4">
                            <% order.products.forEach(function(item){ %>
                            <div class="flex items-center gap-4 p-4 rounded-xl bg-dark-card">
                                <div class="w-20 h-20 rounded-xl flex items-center justify-center flex-shrink-0" style="background: <%= item.bgcolor || '#1a1a1a' %>;">
                                    <% if(item.image) { %>
                                    <img class="w-16 h-16 object-contain" 
                                         src="data:image/jpeg;base64,<%= item.image.toString('base64') %>" 
                                         alt="<%= item.name %>">
                                    <% } else { %>
                                    <i class="ri-shopping-bag-3-line text-3xl text-gray-600"></i>
                                    <% } %>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-medium text-lg"><%= item.name %></h4>
                                    <div class="flex items-center gap-3 mt-1">
                                        <span class="text-accent font-semibold">₹<%= item.price - (item.discount || 0) %></span>
                                        <% if(item.discount > 0) { %>
                                        <span class="text-gray-500 line-through text-sm">₹<%= item.price %></span>
                                        <span class="px-2 py-0.5 rounded bg-green-500/20 text-green-400 text-xs">Save ₹<%= item.discount %></span>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                            <% }) %>
                        </div>
                    </div>

                    <!-- Shipping Address -->
                    <div class="glass rounded-2xl p-6 stagger-item">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="ri-map-pin-line text-accent"></i>
                            Delivery Address
                        </h3>
                        <div class="bg-dark-card rounded-xl p-4">
                            <p class="font-medium text-lg mb-1"><%= order.shippingAddress.fullname %></p>
                            <p class="text-gray-400">
                                <%= order.shippingAddress.address %><br>
                                <%= order.shippingAddress.city %>, <%= order.shippingAddress.state %> - <%= order.shippingAddress.pincode %>
                            </p>
                            <p class="text-gray-400 mt-2">
                                <i class="ri-phone-line"></i> <%= order.shippingAddress.phone %>
                            </p>
                        </div>
                    </div>

                    <!-- Order Tracking Timeline -->
                    <div class="glass rounded-2xl p-6 stagger-item">
                        <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                            <i class="ri-map-pin-2-line text-accent"></i>
                            Tracking Timeline
                        </h3>
                        <div class="relative">
                            <!-- Timeline Line -->
                            <div class="absolute left-5 top-0 bottom-0 w-1 bg-gradient-to-b from-accent via-purple-500 to-gray-700 rounded-full timeline-progress-line"></div>
                            
                            <!-- Timeline Items -->
                            <div class="space-y-6 relative z-10">
                                <% 
                                    const steps = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'];
                                    const currentStep = steps.indexOf(order.orderStatus);
                                    const statusMessages = {
                                        pending: 'Order placed',
                                        confirmed: 'Order confirmed',
                                        processing: 'Being prepared',
                                        shipped: 'On the way',
                                        delivered: 'Delivered'
                                    };
                                    const statusIcons = {
                                        pending: 'ri-shopping-bag-line',
                                        confirmed: 'ri-checkbox-circle-fill',
                                        processing: 'ri-loader-4-line',
                                        shipped: 'ri-truck-line',
                                        delivered: 'ri-checkbox-circle-fill'
                                    };
                                %>
                                <% steps.forEach(function(step, index) { 
                                    const isCompleted = index <= currentStep;
                                    const isCurrent = order.orderStatus === step;
                                %>
                                <div class="flex gap-4 timeline-item" data-step="<%= step %>">
                                    <!-- Timeline Dot -->
                                    <div class="flex flex-col items-center">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 border-2 <%= isCompleted ? 'bg-gradient-to-r from-accent to-purple-500 border-accent' : 'bg-dark-card border-dark-border' %> timeline-dot">
                                            <% if(isCompleted) { %>
                                                <i class="<%= statusIcons[step] %> text-white"></i>
                                            <% } else { %>
                                                <span class="text-gray-500 text-sm"><%= index + 1 %></span>
                                            <% } %>
                                        </div>
                                    </div>
                                    
                                    <!-- Timeline Content -->
                                    <div class="pt-1 pb-4 flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <p class="font-semibold <%= isCompleted ? 'text-white' : 'text-gray-400' %> capitalize">
                                                <%= statusMessages[step] %>
                                            </p>
                                            <% if(isCurrent) { %>
                                                <span class="px-2 py-0.5 text-xs rounded-full bg-accent/20 text-accent font-medium animate-pulse">Current</span>
                                            <% } %>
                                        </div>
                                        <p class="text-sm text-gray-500 capitalize">
                                            <% if(isCompleted && index < currentStep) { %>
                                                Completed on <%= new Date(order.updatedAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
                                            <% } else if(isCurrent) { %>
                                                <%= new Date(order.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
                                            <% } else { %>
                                                Waiting for update
                                            <% } %>
                                        </p>
                                    </div>
                                </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary Sidebar -->
                <div class="space-y-6">
                    <!-- Payment Info -->
                    <div class="glass rounded-2xl p-6 stagger-item">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="ri-bank-card-line text-accent"></i>
                            Payment Info
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Method</span>
                                <span class="font-medium"><%= order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Online' %></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Status</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium capitalize
                                    <%= order.paymentStatus === 'paid' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400' %>">
                                    <%= order.paymentStatus %>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="glass rounded-2xl p-6 stagger-item">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="ri-file-list-3-line text-accent"></i>
                            Price Details
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-gray-400">
                                <span>Subtotal</span>
                                <span class="text-white">₹<%= order.totalAmount %></span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Discount</span>
                                <span class="text-green-400">- ₹<%= order.totalDiscount %></span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Platform Fee</span>
                                <span class="text-white">₹<%= order.platformFee %></span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Shipping</span>
                                <span class="text-green-400">FREE</span>
                            </div>
                            <div class="border-t border-dark-border pt-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Total</span>
                                    <span class="text-2xl font-bold gradient-text">₹<%= order.finalAmount %></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="glass rounded-2xl p-6 stagger-item">
                        <div class="space-y-3">
                            <a href="/users/orders" class="magnetic-btn w-full py-3 rounded-xl bg-dark-card border border-dark-border text-white font-medium hover:border-accent transition-all flex items-center justify-center gap-2">
                                <i class="ri-arrow-left-line"></i>
                                Back to Orders
                            </a>
                            <button onclick="window.location.reload()" class="magnetic-btn w-full py-3 rounded-xl bg-accent/20 border border-accent text-accent font-medium hover:bg-accent/30 transition-all flex items-center justify-center gap-2">
                                <i class="ri-refresh-line"></i>
                                Refresh Tracking
                            </button>
                            <button class="magnetic-btn w-full py-3 rounded-xl bg-gradient-to-r from-accent to-purple-500 text-white font-medium hover:shadow-lg hover:shadow-accent/25 transition-all flex items-center justify-center gap-2">
                                <i class="ri-customer-service-2-line"></i>
                                Need Help?
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .timeline-item:nth-child(1) { animation-delay: 0.1s; }
        .timeline-item:nth-child(2) { animation-delay: 0.2s; }
        .timeline-item:nth-child(3) { animation-delay: 0.3s; }
        .timeline-item:nth-child(4) { animation-delay: 0.4s; }
        .timeline-item:nth-child(5) { animation-delay: 0.5s; }
        
        .order-progress-step {
            transition: all 0.3s ease;
        }
        
        .order-progress-step:hover {
            transform: scale(1.1);
        }
    </style>

    <script>
        // Animate all stagger items
        gsap.from('.stagger-item', {
            y: 30,
            opacity: 0,
            duration: 0.6,
            stagger: 0.1,
            ease: 'power3.out'
        });

        // Animate timeline items
        gsap.from('.timeline-item', {
            x: -30,
            opacity: 0,
            duration: 0.5,
            stagger: 0.15,
            ease: 'power3.out',
            delay: 0.3
        });

        // Animate timeline dots with bounce
        gsap.from('.timeline-dot', {
            scale: 0,
            opacity: 0,
            duration: 0.4,
            stagger: 0.15,
            ease: 'back.out(1.7)',
            delay: 0.5
        });

        // Animate progress bar
        gsap.from('.timeline-progress-line', {
            scaleY: 0,
            transformOrigin: 'top',
            duration: 1,
            ease: 'power2.out',
            delay: 0.2
        });

        // Animate order progress steps
        const steps = document.querySelectorAll('.flex.justify-between.relative > div');
        steps.forEach((step, index) => {
            gsap.from(step, {
                y: 20,
                opacity: 0,
                duration: 0.4,
                delay: 0.1 * index,
                ease: 'power2.out'
            });
