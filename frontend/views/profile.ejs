<%- include('./partials/header') %>

    <!-- Success/Error Toasts -->
    <% if (typeof success !== 'undefined' && success && success.length > 0) { %>
    <div class="fixed top-24 left-1/2 -translate-x-1/2 z-50">
        <div class="glass px-6 py-4 rounded-2xl border border-green-500/30 flex items-center gap-3" id="toast">
            <i class="ri-check-line text-green-400"></i>
            <span class="text-green-400 font-medium"><%= success %></span>
        </div>
    </div>
    <% } %>
    <% if (typeof error !== 'undefined' && error && error.length > 0) { %>
    <div class="fixed top-24 left-1/2 -translate-x-1/2 z-50">
        <div class="glass px-6 py-4 rounded-2xl border border-red-500/30 flex items-center gap-3" id="toast">
            <i class="ri-error-warning-line text-red-400"></i>
            <span class="text-red-400 font-medium"><%= error %></span>
        </div>
    </div>
    <% } %>

    <!-- Profile Section -->
    <div class="relative z-10 min-h-screen pt-28 pb-12 px-6">
        <div class="max-w-5xl mx-auto">
            <!-- Profile Header -->
            <div class="glass rounded-3xl p-8 mb-8">
                <div class="flex flex-col md:flex-row items-center gap-8">
                    <!-- Avatar -->
                    <div class="relative">
                        <div class="w-32 h-32 rounded-full bg-gradient-to-br from-accent to-purple-500 flex items-center justify-center text-5xl font-bold">
                            <%= user.fullname.charAt(0).toUpperCase() %>
                        </div>
                    </div>
                    <!-- Info -->
                    <div class="text-center md:text-left flex-1">
                        <h1 class="text-3xl font-space font-bold mb-2"><%= user.fullname %></h1>
                        <p class="text-gray-400 mb-4"><%= user.email %></p>
                        <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                            <div class="px-4 py-2 rounded-xl bg-dark-card border border-dark-border">
                                <span class="text-gray-500 text-sm">Member since</span>
                                <p class="font-semibold"><%= new Date(user.createdAt || Date.now()).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) %></p>
                            </div>
                            <div class="px-4 py-2 rounded-xl bg-dark-card border border-dark-border">
                                <span class="text-gray-500 text-sm">Wishlist</span>
                                <p class="font-semibold"><%= user.wishlist ? user.wishlist.length : 0 %></p>
                            </div>
                            <% if (user.referralCode) { %>
                            <div class="px-4 py-2 rounded-xl bg-dark-card border border-dark-border">
                                <span class="text-gray-500 text-sm">Referral Code</span>
                                <p class="font-semibold font-mono"><%= user.referralCode %></p>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tabs -->
            <div class="grid md:grid-cols-3 gap-8">
                <!-- Sidebar -->
                <div class="glass rounded-2xl p-6 h-fit">
                    <nav class="space-y-2">
                        <a href="/users/profile" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-dark-card transition-all">
                            <i class="ri-user-line text-accent"></i>
                            <span>My Profile</span>
                        </a>
                        <a href="/users/orders" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-dark-card transition-all text-gray-400 hover:text-white">
                            <i class="ri-shopping-bag-3-line"></i>
                            <span>My Orders</span>
                        </a>
                        <a href="/users/wishlist" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-dark-card transition-all text-gray-400 hover:text-white">
                            <i class="ri-heart-line"></i>
                            <span>Wishlist</span>
                        </a>
                        <div class="border-t border-dark-border my-4"></div>
                        <a href="/users/logout" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-500/10 transition-all text-red-400">
                            <i class="ri-logout-box-line"></i>
                            <span>Logout</span>
                        </a>
                    </nav>
                </div>

                <!-- Content -->
                <div class="md:col-span-2 space-y-6">
                    <!-- Personal Information -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold flex items-center gap-2">
                                <i class="ri-user-settings-line text-accent"></i>
                                Personal Information
                            </h3>
                            <button onclick="toggleEditProfile()" class="text-accent hover:text-accent-light transition-colors" id="editProfileBtn">
                                <i class="ri-edit-line"></i> Edit
                            </button>
                        </div>
                        
                        <!-- View Mode -->
                        <div id="profileView" class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="text-sm text-gray-500 block mb-1">Full Name</label>
                                <p class="font-medium"><%= user.fullname %></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-500 block mb-1">Email Address</label>
                                <p class="font-medium"><%= user.email %></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-500 block mb-1">Phone Number</label>
                                <p class="font-medium <%= user.contact ? '' : 'text-gray-400' %>"><%= user.contact || 'Not added' %></p>
                            </div>
                        </div>
                        
                        <!-- Edit Mode -->
                        <form id="profileEdit" class="hidden" action="/users/profile/update" method="POST">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-sm text-gray-500 block mb-2">Full Name</label>
                                    <input type="text" name="fullname" value="<%= user.fullname %>" required
                                        class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500 block mb-2">Email Address</label>
                                    <input type="email" name="email" value="<%= user.email %>" required
                                        class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500 block mb-2">Phone Number</label>
                                    <input type="tel" name="contact" value="<%= user.contact || '' %>" placeholder="Enter phone number"
                                        class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button type="submit" class="px-6 py-3 rounded-xl bg-gradient-to-r from-accent to-purple-500 text-white font-medium">
                                    Save Changes
                                </button>
                                <button type="button" onclick="toggleEditProfile()" class="px-6 py-3 rounded-xl border border-dark-border hover:border-accent transition-all">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Saved Addresses -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold flex items-center gap-2">
                                <i class="ri-map-pin-line text-pink-400"></i>
                                Saved Addresses
                            </h3>
                            <button onclick="openAddressModal()" class="magnetic-btn px-4 py-2 rounded-xl bg-dark-card border border-dark-border text-sm font-medium hover:border-accent transition-all">
                                <i class="ri-add-line"></i> Add New
                            </button>
                        </div>
                        
                        <% if (user.addresses && user.addresses.length > 0) { %>
                        <div class="space-y-4">
                            <% user.addresses.forEach((addr, index) => { %>
                            <div class="p-4 rounded-xl bg-dark-card border border-dark-border relative">
                                <% if (addr.isDefault) { %>
                                <span class="absolute top-3 right-3 px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full">Default</span>
                                <% } %>
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-accent/20 flex items-center justify-center flex-shrink-0">
                                        <i class="ri-<%= addr.type === 'home' ? 'home' : addr.type === 'work' ? 'building' : 'map-pin' %>-line text-accent"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-medium capitalize"><%= addr.type %></span>
                                            <span class="text-gray-500">â€¢</span>
                                            <span class="text-gray-400"><%= addr.fullname %></span>
                                        </div>
                                        <p class="text-gray-400 text-sm"><%= addr.address %>, <%= addr.city %>, <%= addr.state %> - <%= addr.pincode %></p>
                                        <p class="text-gray-500 text-sm mt-1"><%= addr.phone %></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <% if (!addr.isDefault) { %>
                                        <form action="/users/address/<%= addr._id %>/default" method="POST" class="inline">
                                            <button type="submit" class="p-2 hover:bg-accent/20 rounded-lg transition-all" title="Set as default">
                                                <i class="ri-checkbox-circle-line text-gray-400 hover:text-accent"></i>
                                            </button>
                                        </form>
                                        <% } %>
                                        <form action="/users/address/<%= addr._id %>/delete" method="POST" class="inline">
                                            <button type="submit" class="p-2 hover:bg-red-500/20 rounded-lg transition-all" title="Delete">
                                                <i class="ri-delete-bin-line text-gray-400 hover:text-red-400"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <% }) %>
                        </div>
                        <% } else { %>
                        <div class="text-center py-8 text-gray-500">
                            <i class="ri-map-pin-line text-4xl mb-3 block"></i>
                            <p>No addresses saved yet</p>
                            <p class="text-sm">Add an address for faster checkout</p>
                        </div>
                        <% } %>
                    </div>

                    <!-- Security -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-xl font-semibold flex items-center gap-2 mb-6">
                            <i class="ri-shield-check-line text-green-400"></i>
                            Security
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 rounded-xl bg-dark-card">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-accent/20 flex items-center justify-center">
                                        <i class="ri-lock-password-line text-accent"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">Password</h4>
                                        <p class="text-sm text-gray-500">Keep your account secure</p>
                                    </div>
                                </div>
                                <button onclick="openPasswordModal()" class="px-4 py-2 rounded-lg border border-dark-border hover:border-accent transition-all text-sm">
                                    Change
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Address Modal -->
    <div id="addressModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="glass rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Add New Address</h2>
                <button onclick="closeAddressModal()" class="p-2 hover:bg-dark-card rounded-full">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            
            <form action="/users/address/add" method="POST" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">Full Name</label>
                        <input type="text" name="fullname" required class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">Phone</label>
                        <input type="tel" name="phone" required class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="text-sm text-gray-500 block mb-2">Address</label>
                    <textarea name="address" rows="2" required class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none resize-none"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">City</label>
                        <input type="text" name="city" required class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">State</label>
                        <input type="text" name="state" required class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">Pincode</label>
                        <input type="text" name="pincode" required class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">Address Type</label>
                        <select name="type" class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                            <option value="home">Home</option>
                            <option value="work">Work</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="isDefault" id="isDefault" class="accent-accent">
                    <label for="isDefault" class="text-sm text-gray-400">Set as default address</label>
                </div>
                
                <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-accent to-purple-500 text-white font-medium">
                    Add Address
                </button>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="glass rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Change Password</h2>
                <button onclick="closePasswordModal()" class="p-2 hover:bg-dark-card rounded-full">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            
            <form action="/users/password/change" method="POST" class="space-y-4">
                <div>
                    <label class="text-sm text-gray-500 block mb-2">Current Password</label>
                    <input type="password" name="currentPassword" required class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                </div>
                
                <div>
                    <label class="text-sm text-gray-500 block mb-2">New Password</label>
                    <input type="password" name="newPassword" required minlength="6" class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                </div>
                
                <div>
                    <label class="text-sm text-gray-500 block mb-2">Confirm New Password</label>
                    <input type="password" name="confirmPassword" required minlength="6" class="w-full bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white focus:border-accent outline-none">
                </div>
                
                <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-accent to-purple-500 text-white font-medium">
                    Update Password
                </button>
            </form>
        </div>
    </div>

    <script>
        function toggleEditProfile() {
            document.getElementById('profileView').classList.toggle('hidden');
            document.getElementById('profileEdit').classList.toggle('hidden');
            const btn = document.getElementById('editProfileBtn');
            btn.innerHTML = document.getElementById('profileView').classList.contains('hidden') 
                ? '<i class="ri-close-line"></i> Cancel' 
                : '<i class="ri-edit-line"></i> Edit';
        }
        
        function openAddressModal() {
            document.getElementById('addressModal').classList.remove('hidden');
        }
        
        function closeAddressModal() {
            document.getElementById('addressModal').classList.add('hidden');
        }
        
        function openPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
        }
        
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
        }
        
        // Auto-hide toast
        setTimeout(() => {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }
        }, 3000);
    </script>

<%- include('./partials/footer') %>
